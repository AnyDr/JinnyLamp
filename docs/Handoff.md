“Контекст для продолжения разработки: инварианты, железо, важные модули, известные проблемы, что делать дальше”.

!!!!!!!!!!!!!!!!!В конце каждой рабочей сессии обязательно правка docs файлов с внеснными изменениями и довавлеными фичами!!!!!!!!!!!!!!!!!!!

HANDOFF — Jinny Lamp (ESP32-S3 + XVF3800 + WS2812)

## 1. Общая информация

**Проект:** Jinny Lamp
**Цель:**
Разработка умной лампы с адресной RGB-матрицей (WS2812), аудио-входом через XVF3800 и управлением/реакцией на звук. Проект строится с упором на **стабильность, диагностируемость и расширяемость**, без “магических” решений.

**Текущий статус:**
Рабочий baseline. Система стабильно собирается, прошивается и работает без фликера.

---

## 2. Аппаратная архитектура

### 2.1 MCU и базовая плата

* **MCU:** ESP32-S3
* **Плата:** XIAO ESP32-S3, интегрированная в плату **XVF3800** (voice DSP)

### 2.2 Связь ESP32-S3 ↔ XVF3800

* **I2C**

  * Управление / статусы
  * Используется стабильно
* **I2S (STD mode)**

  * ESP32-S3 — master
  * RX: аудио с XVF3800
  * TX: loopback обратно в XVF3800
  * Частота: **16 kHz**
  * Формат: **32-bit слова**, полезные данные 24-bit (`raw >> 8`)

### 2.3 Световая часть

* **Тип:** WS2812 (NeoPixel)
* **Конфигурация:**

  * 3 × матрицы 16×16
  * Итог: **48 × 16 = 768 LED**
* **DATA:**

  * GPIO3 ESP32-S3
  * Через level shifter (3.3 V → 5 V)
* **Питание:**

  * 5 V
  * Low-side MOSFET (отключение земли)
* **Ключевой инвариант питания:**

  ```
  DATA = LOW
  → включить питание матриц
  → задержка
  → первый refresh
  ```

---

## 3. Программная архитектура (ESP-IDF)

### 3.1 Общая структура

* Все прикладные файлы находятся в `main/`
* Используется managed component:

  * `espressif/led_strip` версии **2.5.5**
* WS2812 работает через **RMT + DMA** (ESP32-S3)

---

## 4. Назначение файлов

### `main.c`

**Роль:** точка входа `app_main()`

**Порядок инициализации:**

1. `led_control_init()` — статусный LED
2. `audio_i2s_init()` — I2S ESP32 ↔ XVF3800
3. `matrix_anim_start()` — запуск анимации WS2812
4. `asr_debug_start()` — аудио-debug задача

---

### `matrix_ws2812.c / .h`

**Роль:** низкоуровневый драйвер буфера WS2812

**Функции:**

* Инициализация `led_strip` (RMT, DMA)
* XY → index:

  * 3 панели
  * serpentine
  * configurable через макросы
* `set_pixel_xy()` — запись в буфер
* `show()` — единственный refresh
* **software brightness scaling**
* `static_one_pixel_test()`:

  * 1 пиксель
  * 1 refresh
  * дальше тишина (диагностика аппаратных проблем)

**Инварианты:**

* Яркость масштабируется **только софтверно**
* Любой `show()` = передача по RMT
* Если при static-test есть мерцание → проблема **аппаратная**

---

### `matrix_anim.c / .h`

**Роль:** высокоуровневая анимация

**Архитектура:**

* Отдельная FreeRTOS task
* FPS ≈ **10**
* Единственный владелец `matrix_ws2812_show()`

**Текущая анимация:**

* Переливающийся диагональный градиент
* Направление: **снизу → вверх**
* Цвет через `wheel()`

**Инварианты:**

* Нельзя делать `show()` из других задач
* Переполнение `uint8_t hue` намеренное (wrap-around)

---

### `audio_i2s.c / .h`

**Роль:** обёртка над I2S STD драйвером

**Параметры:**

* 16 kHz
* 32-bit
* stereo
* RX + TX

**Особенности:**

* Защита от повторного init
* Данные читаются как `int32_t`
* Полезные 24-bit извлекаются `>> 8`

---

### `asr_debug.c / .h`

**Роль:** отладка аудио тракта

**Логика:**

1. Калибровка шумового порога (`noise_floor`)
2. Подсчёт `avg_abs` по левому каналу
3. Расчёт уровня: “на сколько % громче шума”
4. Гистерезис:

   * `LEVEL_ON`
   * `LEVEL_OFF`
5. Управление status LED
6. Loopback аудио в TX

**Fail-safe:**

* При серии ошибок I2S → `esp_restart()`

---

### `led_control.c / .h`

**Роль:** статусный LED

* GPIO21
* **Active LOW**
* Используется в `asr_debug` как индикатор уровня

---

## 5. Текущий baseline (КРИТИЧНО)

**Статус:**

* Билд: ✅
* Прошивка: ✅
* WS2812: ✅ стабильный, без фликера
* I2S: ✅ RX/TX работают
* XVF3800: ✅ отвечает
* Анимация: ✅ стабильна

**Git-тег (якорь):**

```
jinny_baseline_ws2812_i2s_v1
```

Этот тег — **точка возврата**, если что-то сломается.

---

## 6. Инварианты / НЕ ЛОМАТЬ

* Никаких параллельных `matrix_ws2812_show()`
* DATA всегда LOW при включении питания матриц
* Яркость WS2812 — только через software scaling
* I2S предполагает 24-bit данные в 32-bit слове
* static_one_pixel_test — эталон диагностики

---

## 7. Технический долг / следующие шаги

Планируемые направления:

1. Power-sequencing WS2812 через MOSFET
2. Sleep / wake режимы (ESP32 + XVF)
3. Вынесение `main/` → `components/`
4. Аудио-реактивные анимации
5. Интеграция с внешним управлением (MQTT / HA)

---