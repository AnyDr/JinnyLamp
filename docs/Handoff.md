“Контекст для продолжения разработки: инварианты, железо, важные модули, известные проблемы, что делать дальше”.

ВАЖНО: в конце каждой рабочей сессии - обновлять docs/ (handoff, architecture, espnow, commands, adr), фиксировать новые фичи и изменения.

# HANDOFF - Jinny Lamp (ESP32-S3 + XVF3800 + WS2812)

## 1. Общая информация
Проект: Jinny Lamp

Цель:
Прошивка умной лампы с адресной RGB-матрицей (WS2812), аудио-трактом через XVF3800 и управлением:
- локально (кнопка TTP223),
- удаленно (ESP-NOW с пульта),
- в будущем: Wi-Fi/MQTT (Home Assistant).

Фокус: стабильность, диагностируемость, расширяемость. Минимум неявных зависимостей.

Текущий статус:
- Сборка и прошивка: OK
- WS2812: OK, стабильный вывод
- ESP-NOW: поднят, связь с пультом работает (power/pause/brightness/speed_pct подтверждены)
- SET_ANIM: протокол есть, но фактическая смена эффекта зависит от согласованной таблицы effect_id (см. docs/espnow.md)

## 2. Аппаратная архитектура (факт)
### 2.1 MCU и плата
- MCU: ESP32-S3 (XIAO)
- База: плата ReSpeaker XVF3800 (voice DSP), XIAO интегрирован

### 2.2 Связь ESP32-S3 <-> XVF3800
- I2C: управление/статусы, чтение GPIO XVF, управление GPO (в т.ч. ключ питания матриц)
- I2S: аудио RX/TX (используется в проекте; параметры смотреть в audio_i2s.*)

### 2.3 Световая часть
- WS2812B: 3 матрицы 16×16, daisy-chain, итого 48×16 = 768 LED
- DATA: GPIO3 ESP32-S3 через 74AHCT125 (5V), после него серийный резистор 330–470 Ω
- Питание: +5V напрямую, GND коммутируется low-side N-MOSFET
- Gate MOSFET: с XVF3800 GPO X0D11, Rgate ~100 Ω, pulldown ~100 kΩ (опц. Cgs 10–47 nF)
- Критический инвариант включения WS2812: DATA=LOW -> MOSFET ON -> задержка -> передача данных
- Критический инвариант выключения WS2812: остановить анимацию -> DATA=LOW -> MOSFET OFF

## 3. Программная архитектура (ESP-IDF)
### 3.1 Общее
- ESP-IDF: v5.5.1
- Код приложения в `main/`
- WS2812 через led_strip (RMT + DMA на ESP32-S3)

### 3.2 Важные модули (куда смотреть)
- `main.c` - app_main(), порядок инициализации, (возможная) sleep логика
- `matrix_ws2812.*` - низкоуровневый драйвер “framebuffer + show”
- `matrix_anim.*` - задача отрисовки кадров (единственный владелец show)
- `fx_engine.*`, `fx_registry.*`, `fx_canvas.*` - движок эффектов, реестр effect_id
- `ctrl_bus.*` - источник истины состояния: effect_id/brightness/speed_pct/paused/power, seq/state_seq
- `j_wifi.*` - Wi-Fi STA, источник текущего канала (AP channel или fallback channel)
- `j_espnow_link.*` + `j_espnow_proto.h` - прием команд, применение через ctrl_bus, отправка ACK
- `input_ttp223.*` - локальные клики/лонг и т.д. (если включено)
- `asr_debug.*` - аудио debug (может “шуметь” логами)
- `audio_i2s.*` - I2S драйвер/обвязка

### 3.3 Факт по логам старта (ориентир)
По monitor видно последовательность ключевых подсистем:
- Wi-Fi init + STA start
- (если SSID пустой) ESPNOW-only и fallback channel
- ESPNOW init + (peer может быть задан или пустой)
- затем инициализация I2C/XVF, input, fx_engine/ctrl_bus, сенсоры/аудио, матрица и anim task

## 4. Инварианты (НЕ ЛОМАТЬ)
- ESPNOW зависит от Wi-Fi канала: всегда управлять каналом в одном месте (j_wifi)
- Состояние истины - лампа (ctrl_bus). Пульт только отправляет команды и принимает ACK snapshot
- Драйвер матрицы: один поток владения show (matrix_anim task), не делать show из разных задач
- Силовой инвариант WS2812: DATA=LOW при включении/выключении питания матриц
- Яркость - через софтверное scaling (как реализовано в matrix_ws2812 / движке)

## 5. Известные тонкие места / риски
- Несовпадение effect_id между пультом и лампой ломает SET_ANIM (будет чиниться согласованием registry или протоколом “запрос списка эффектов”)
- Wi-Fi канал: при будущем подключении к AP канал будет диктоваться AP, ESPNOW обязан следовать ему
- Шумные логи ASR_DEBUG мешают диагностике (см. docs/commands.md: как приглушать)
- В логах лампы встречалось предупреждение про размер flash в заголовке бинаря vs “detected size”.
  Это не “ломает” сразу, но требует внимания к настройкам flash/partition (проверять sdkconfig и partition table)

## 6. Базовый якорь (исторический baseline)
Тег-ориентир, который использовался как точка возврата:
- `jinny_baseline_ws2812_i2s_v1`

Если появится новый стабильный “якорь” после ESPNOW, фиксировать отдельным тегом.

## 7. Следующие шаги (в рамках текущей линии разработки)
1) Документировать и согласовать effect_id между лампой и пультом (источник - fx_registry лампы)
2) При необходимости: ввести протокол “lamp->remote: список эффектов” (не делать без полного понимания требований)
3) Уточнить правила “когда пульт имеет право слать команды лампе” (сейчас команды могут уходить даже при смене экранов на пульте)
4) Описывать каждую новую фичу в docs + ADR

## 8. Известные проблеммы требующие решения и контроля, смотри файл docs/Tech_debt