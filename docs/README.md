# Jinny Lamp (ESP32-S3 + XVF3800 + WS2812)

## Что это
Jinny Lamp - прошивка для умной лампы на базе XIAO ESP32-S3, установленного на плате ReSpeaker XVF3800 (DSP/voice). Является частью разработываемых устройств умного дома, способна работать как офлайн так и с подключением к домашнему серверу под управлением OS ESP Home.  Лампа управляет адресными RGB матрицами WS2812 (3×16×16, итого 48×16 = 768 LED), умеет проигрывать эффекты и принимать команды управления по ESP-NOW и Wi-Fi MQTT. Идея родилась после увиденого проекта умной лампы у Alex Gyvver, и была творчески переработана сама концепция, из его проекта взята только идея лампы на матрице, все остальное сделал сам, и помощью всех доступный гайдов, видео, и нейросетей (ввиду отстутсвия опыта, я любитель, а не проффессионал и моя реальная работа совсем в другом).

Концептуальная идея - это лампа (хотя конечно это больше световой столб, 50 см высоты), в которой сидит джин (именоо поэтому Jinny`s Lamp). Его роль выполняет крохотная LLM установленная на самой лампе, и понимающая голосовые команды пользователя офлайн, в широком спектре этих команд, с wake word, и ответом пользователю через встроенный динамик с помощью заранее записанных ауйдиофайлов хранящихся в памяти. Для обработки голоса пользователя и пришлось использовать Re Speaker XVF3800 4-Mic Array with XIAO ESP32-S3 так как он реально хорош в принятии и обработке голоса от пользователя. По задумке джин имеет свой характер, он вечно всем недоволен, ему не нравиться ни лампа, ни люди, ни окружение, у него своеобразное чувство юмора, и у него широкий спектр ответов на разные команды пользвателя. Для создания аудиофайлов планируется использовать нейросеть генерации звука, для достижения требуемого тембра, интонаций и эмоций джина. Какие то ответы будут жестко приязаны к функциям, какие то свободны для случайного выбора. 
При произнесении wake word, поверх текущей анимации будет появялться лицо джина окруженное пламенем, с анимацией ожидания команды от пользователя и ответа самого джина. После выполнения команды джин исчезает и анимация возобновляется. 

В автономном режиме (оффлайн) лампа способна выполнять роль светильника, с широким выбором анимаций, оффлайн голосовым управлением, и управлением через спрятанную сенсорную кнопку. 
При подключении беспроводного пульта (другая часть этого проекта так же на ESP32S3), появляется возможность тонкой настройки этой лампы, такие как яркость, скорость анимаций, листинг всех доступных анимаций в ускоренном или поочередной скорости, отображение информации о текущей температуре в комнате, температуры лампы (самая горячая часть матрицы), стоимости расхода энергии в моменте, потребляемой мощности. 

При подключении к домашнему серверу под управлением ESP Home, получает доступ у более продвинутой нейросети класса 3В, и может отвечать уже более осмыслено, вести беседу, а не заранее прописаными фразами. Так же транслирует голосовые команды пользователся в сервер дома при необходимости, может управлять другими устройсвами в сети через центр ESP Home в более или менее свободной устной форме, без жестко заданных фраз активации. 
Степень праноидальной надежности:
1. Подразумевает полноценный  режим работы без интеренета, только подключение к серверу умного дома через Wi-Fi для координации устройств и данных внутри домашней сети, превращении голосовых команд пользователя в конкретные команды. 
2. При отстутствиии сервера умного дома, общается с пультом по ESP-NOW, транслирует данные на пульт, слушает, отвечает и реагирует на голосовые команды пользователя.
3. При отстутствии и сервера и пульта имеет физическое управление с помощью сенсорной кнопки и встроеного голосового модуля. 



Ключевая цель проекта: надёжность, простота использования, создание интерактивного элемента дома дающего какой то уют, иммитация разума, понятная модульная архитектура.

Стратегия связи: ESPNOW сейчас, Wi-Fi STA/MQTT позже (один радиомодуль, общий канал).

Является часть

## Аппаратная часть (кратко)
- MCU: ESP32-S3 (XIAO, интегрирован на плате XVF3800)
- LED: 3× WS2812B 16×16 daisy-chain, раскладка “змейкой”
- DATA: GPIO3 ESP32-S3 -> level shifter 74AHCT125 (5V) -> серийный резистор 330–470 Ω -> матрицы
- Питание матриц: +5V напрямую, GND коммутируется low-side N-MOSFET
- Gate MOSFET управляется XVF3800 GPO (X0D11), с Rgate ~100 Ω и pulldown ~100 kΩ
- Инвариант включения WS2812: DATA=LOW -> MOSFET ON -> задержка -> отправка данных
- Инвариант выключения WS2812: stop anim -> DATA=LOW -> MOSFET OFF

## Что сейчас работает (факт по текущему состоянию)
- Движок эффектов и рендер (fx_engine + fx_registry + fx_canvas)
- Анимационная задача (matrix_anim)
- Управление состоянием (ctrl_bus): effect_id / brightness / speed_pct / pause / power
- ESP-NOW управление от пульта: power / pause / brightness / speed_pct
  - SET_ANIM поддержан протоколом, но корректность зависит от совпадения таблицы effect_id на пульте и fx_registry лампы
- Wi-Fi STA поднят как радио-база (SSID может быть пустым для ESPNOW-only)
- Отладка аудио тракта (asr_debug) может шуметь логами (см. docs/architecture.md и docs/commands.md)

## Документация (куда смотреть)
- `docs/Handoff.md` - “статус проекта и где продолжать” (самое важное)
- `docs/architecture.md` - модули, потоки данных, задачи, порядок инициализации, инварианты
- `docs/espnow.md` - ESP-NOW: канал, pairing по MAC, команды, ACK, диагностика
- `docs/commands.md` - команды разработчика и семантика управляющих команд
- `docs/fx_fire.md` - документация сложного эффекта FIRE (по факту файла fx_effects_fire.c)
- `docs/adr/` - ADR (Architecture Decision Records): ключевые решения “почему так”

## Структура кода (ядро)
- `main.c` - старт системы, порядок инициализации, deep sleep логика (если включена)
- `j_wifi.c/.h` - Wi-Fi STA (сейчас как база радио-стека и источник канала; SSID может быть пустым для ESPNOW-only)
- `j_espnow_link.c/.h` + `j_espnow_proto.h` - транспорт управления и ACK
- `ctrl_bus.*` - состояние управления и очередь/применение команд
- `matrix_ws2812.*` - драйвер матрицы (буфер кадра, XY->index, show)
- `matrix_anim.*` - задача обновления кадров
- `fx_engine.*`, `fx_registry.*`, `fx_canvas.*` - движок эффектов и реестр
- `fx_effects_simple.c` - простые эффекты (пачкой)
- `fx_effects_fire.c` - сложный эффект FIRE (отдельно)


## Анмации стоящие отго что бы отметить отдельно
- Огненная анимация, по сути моделируемый контроллером реальное поведение факела. Для детального анализа смотри docs/fx_fire.md