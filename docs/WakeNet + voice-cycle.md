* Variant A (SOFT OFF –±–µ–∑ —Å–≤–µ—Ç–∞),
* –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–ª–æ–∫/–∫–æ–º–∞–Ω–¥,
* –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ `audio_bus`,
* —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (–±–µ–∑ —Ñ–∞–Ω—Ç–∞–∑–∏–π –∏ –±–µ–∑ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∏–∫—Å–æ–≤ —Ç–µ—Ö–¥–æ–ª–≥–∞).

–ö–æ–¥–∞ **–Ω–µ –ø–∏—à—É**, —Ç–æ–ª—å–∫–æ –ø–ª–∞–Ω, –∫–∞–∫ –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞–ª–∏—Å—å.

---

# M4 ‚Äî WakeNet + Voice-cycle (Variant A)

## –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Ü–µ–ª–∏

–î–æ–±–∞–≤–∏—Ç—å **wake-word (ESP-SR WakeNet)** –∏ **–ø–æ–ª–Ω—ã–π –≥–æ–ª–æ—Å–æ–≤–æ–π —Ü–∏–∫–ª**:

```
SOFT OFF:
  wake ‚Üí –≥–æ–ª–æ—Å–æ–≤–æ–π –æ—Ç–≤–µ—Ç ‚Üí (–¥–∞–ª—å—à–µ —Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ –∏ –≤ ON)
  –ù–û: –º–∞—Ç—Ä–∏—Ü–∞ –≤—Å–µ–≥–¥–∞ OFF, –Ω–∏–∫–∞–∫–∏—Ö –∞–Ω–∏–º–∞—Ü–∏–π

ON:
  wake ‚Üí –≥–æ–ª–æ—Å–æ–≤–æ–π –æ—Ç–≤–µ—Ç ‚Üí (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞)
  (–≤–∏–∑—É–∞–ª –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–∑–∂–µ, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∏—Ç—Å—è –∑–∞—Ä–∞–Ω–µ–µ)
```

**–û—Ç–ª–∏—á–∏–µ SOFT OFF –æ—Ç ON ‚Äî –¢–û–õ–¨–ö–û –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ LED/FX.
–ì–æ–ª–æ—Å –∏ –ª–æ–≥–∏–∫–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã.**

---

## –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã —ç—Ç–∞–ø–∞ (–∂—ë—Å—Ç–∫–æ)

1. **–ú–∞—Ç—Ä–∏—Ü–∞**

   * –í SOFT OFF:

     * `matrix_anim` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
     * `matrix_ws2812_*` –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
     * –Ω–∏–∫–∞–∫–∏—Ö overlay, –¥–∞–∂–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö
   * –í ON:

     * –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ —Ä–µ–≥—Ä–µ—Å—Å–∏—Ä—É–µ—Ç (22 FPS, single show owner)

2. **–ê—É–¥–∏–æ**

   * RX –≤—Å–µ–≥–¥–∞ —á–µ—Ä–µ–∑ `audio_stream`
   * TX —á–µ—Ä–µ–∑ `audio_player`
   * –ì—Ä–æ–º–∫–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ** —á–µ—Ä–µ–∑ `audio_bus`
   * –í–æ –≤—Ä–µ–º—è SPEAK: anti-feedback (wake OFF)

3. **Wake**

   * WakeNet —Ä–∞–±–æ—Ç–∞–µ—Ç **–≤ ON –∏ –≤ SOFT OFF**
   * Wake –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç —Å–≤–µ—Ç
   * Wake –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –≥–æ–ª–æ—Å–æ–≤–æ–º—É –æ—Ç–≤–µ—Ç—É

4. **–û–±–ª–∞—Å—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**

   * M4 **–Ω–µ –≤–∫–ª—é—á–∞–µ—Ç** —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥ (MultiNet, —Å–µ—Ä–≤–µ—Ä –∏ —Ç.–ø.)
   * –¢–æ–ª—å–∫–æ wake + voice plumbing

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –±–ª–æ–∫–∏ (–∫–∞–∫ –æ–Ω–∏ –±—É–¥—É—Ç –∂–∏—Ç—å)

### 1) audio_stream ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∞—É–¥–∏–æ (—É–∂–µ –µ—Å—Ç—å)

–ò—Å–ø–æ–ª—å–∑—É–µ–º **–∫–∞–∫ –µ—Å—Ç—å**:

* mono s16 @ 16 kHz
* –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–π ringbuffer
* –¥–æ–ø—É—Å–∫–∞–µ—Ç –¥—Ä–æ–ø—ã
* –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è WakeNet

–ù–∏–∫–∞–∫–∏—Ö –ø—Ä–∞–≤–æ–∫.

---

### 2) audio_bus ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –ø–æ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ (—É–∂–µ –µ—Å—Ç—å)

–ò—Å–ø–æ–ª—å–∑—É–µ–º **–∫–∞–∫ –µ—Å—Ç—å**:

* persist + debounce
* –ø—Ä–∏–º–µ–Ω—è–µ—Ç –≥—Ä–æ–º–∫–æ—Å—Ç—å —á–µ—Ä–µ–∑ `audio_player_set_volume_pct()`
* voice-cycle **–Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç volume**

---

### 3) voice_events ‚Äî ‚Äú—á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç—å‚Äù (—É–∂–µ –µ—Å—Ç—å)

–ò—Å–ø–æ–ª—å–∑—É–µ–º **–∫–∞–∫ –µ—Å—Ç—å**:

* `voice_event_post(evt)` ‚Üí –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ PCM
* shuffle-bag, persistent mask
* **–Ω–µ –∑–Ω–∞–µ—Ç** –ø—Ä–æ wake / FSM (–∏ –Ω–µ –¥–æ–ª–∂–µ–Ω)

---

## –ù–æ–≤—ã–π —Å–ª–æ–π, –∫–æ—Ç–æ—Ä—ã–π –º—ã –¥–æ–±–∞–≤–ª—è–µ–º

### 4) voice_fsm ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π voice lifecycle (–ù–û–í–´–ô –º–æ–¥—É–ª—å)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
–°–≤—è–∑–∞—Ç—å wake, audio_stream, audio_player –∏ voice_events –≤ **–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ü–∏–∫–ª**.

#### –°–æ—Å—Ç–æ—è–Ω–∏—è FSM

```
VOICE_IDLE
  wake ON
  audio_stream normal

VOICE_LISTENING
  wake ON
  (–æ–∫–Ω–æ listen, –ø–æ–∫–∞ –±–µ–∑ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è)

VOICE_SPEAKING
  wake OFF
  audio_stream pause/drop
  audio_player active

VOICE_POST_GUARD
  wake OFF
  –∫–æ—Ä–æ—Ç–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
  flush audio_stream
```

> ‚ö†Ô∏è FSM **–Ω–µ –∑–Ω–∞–µ—Ç**, ON –º—ã –∏–ª–∏ SOFT OFF.
> –≠—Ç–æ —Ä–µ—à–∞–µ—Ç power_management, FSM ‚Äî —á–∏—Å—Ç–æ –ª–æ–≥–∏–∫–∞ –≥–æ–ª–æ—Å–∞.

---

### 5) wakenet_task ‚Äî ESP-SR WakeNet consumer (–ù–û–í–´–ô –º–æ–¥—É–ª—å)

**–û–¥–∏–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π task.**

#### –ü–æ–≤–µ–¥–µ–Ω–∏–µ

* —á–∏—Ç–∞–µ—Ç –∏–∑ `audio_stream_read_mono_s16()`
* –∫–æ—Ä–º–∏—Ç WakeNet
* –ø—Ä–∏ –¥–µ—Ç–µ–∫—Ç–µ:

  * –ø–æ—Å—Ç–∏—Ç —Å–æ–±—ã—Ç–∏–µ `EV_WAKE_DETECTED` –≤ `voice_fsm`

#### –í–∞–∂–Ω–æ–µ

* –ù–∏–∫–∞–∫–æ–≥–æ –ø—Ä—è–º–æ–≥–æ I2S
* –¢–∞–π–º–∞—É—Ç—ã —á—Ç–µ–Ω–∏—è ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
* –ù–∏–∫–∞–∫–∏—Ö –ª–æ–≥-—à—Ç–æ—Ä–º–æ–≤

---

## –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º

### A) Wake –≤ SOFT OFF (–∫–ª—é—á–µ–≤–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π)

```
power_state == SOFT_OFF
```

1. WakeNet –¥–µ—Ç–µ–∫—Ç–∏—Ç wake
2. `voice_fsm`:

   * –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ SPEAKING
   * **–Ω–µ –≤–∫–ª—é—á–∞–µ—Ç –º–∞—Ç—Ä–∏—Ü—É**
   * –≤—ã–∑—ã–≤–∞–µ—Ç `voice_event_post(WAKE_ACK | THINKING | LISTEN_PROMPT)`
3. –í–æ –≤—Ä–µ–º—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:

   * wake OFF
4. –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è:

   * post-guard
   * –≤–æ–∑–≤—Ä–∞—Ç –≤ IDLE
   * wake ON

üìå **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ª–∞–º–ø–∞ ‚Äú–≥–æ–≤–æ—Ä–∏—Ç‚Äù, –Ω–æ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç—ë–º–Ω–æ–π.

---

### B) Wake –≤ ON

–ü–æ–∫–∞ **–ª–æ–≥–∏—á–µ—Å–∫–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ**, –ø—Ä–æ—Å—Ç–æ:

* –º–∞—Ç—Ä–∏—Ü–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∂–∏—Ç—å —Å–≤–æ–µ–π –∂–∏–∑–Ω—å—é
* –≤–∏–∑—É–∞–ª –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ

---

## –ö–ª—é—á–µ–≤–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ç–æ—á–∫–∞ (—Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è)

### üî¥ –ö–∞–∫ —É–∑–Ω–∞—Ç—å, —á—Ç–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–∫–æ–Ω—á–µ–Ω–æ?

–°–µ–π—á–∞—Å:

* `voice_events` ‚Üí `audio_player_play_*()`
* **–Ω–µ—Ç —Å–∏–≥–Ω–∞–ª–∞ ‚Äúplayback done‚Äù**

### –ü–ª–∞–Ω (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥–ø—É–Ω–∫—Ç M4)

–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º ESP-SR –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –º—ã:

1. –ü—Ä–æ–≤–µ—Ä—è–µ–º `audio_player`:

   * –µ—Å—Ç—å –ª–∏ callback / notify / wait API
2. –ï—Å–ª–∏ **–Ω–µ—Ç**:

   * –¥–æ–±–∞–≤–ª—è–µ–º **–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π** –º–µ—Ö–∞–Ω–∏–∑–º:

     * `audio_player_register_done_cb(cb)`
     * –∏–ª–∏ `audio_player_wait_done()`
     * –∏–ª–∏ `xTaskNotifyGive()` –≤ `voice_fsm`

‚ùó –ë–µ–∑ —ç—Ç–æ–≥–æ FSM –±—É–¥–µ—Ç ‚Äú–Ω–∞ —Ç–∞–π–º–µ—Ä–∞—Ö‚Äù, —á—Ç–æ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ.

–≠—Ç–æ **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ API-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ**, –∫–æ—Ç–æ—Ä–æ–µ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–∞–ø–µ M4.

---

## –ß—Ç–æ –º—ã —Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ –ù–ï –¥–µ–ª–∞–µ–º –≤ M4

* ‚ùå MultiNet / —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥
* ‚ùå –°–µ—Ä–≤–µ—Ä / fallback
* ‚ùå –õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è FX / FIRE / render pipeline
* ‚ùå –í–∫–ª—é—á–µ–Ω–∏–µ LED –Ω–∞ wake –≤ SOFT OFF
* ‚ùå –†–µ—Ñ–∞–∫—Ç–æ—Ä power_management (—É–∂–µ –≤ —Ç–µ—Ö–¥–æ–ª–≥–µ)

---

## –ü–æ—Ä—è–¥–æ–∫ —Ä–∞–±–æ—Ç (—Å—Ç—Ä–æ–≥–æ)

1. **Git checkpoint**

   * `checkpoint/M4_before_wakenet`

2. **–î–æ–±–∞–≤–∏—Ç—å voice_fsm**

   * —Å–æ—Å—Ç–æ—è–Ω–∏—è
   * anti-feedback
   * post-guard
   * –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `voice_events`

3. **–î–æ–±–∞–≤–∏—Ç—å playback-done —Å–∏–≥–Ω–∞–ª**

   * –º–∏–Ω–∏–º–∞–ª—å–Ω–æ
   * –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ –ø–ª–µ–µ—Ä–∞

4. **–î–æ–±–∞–≤–∏—Ç—å wakenet_task**

   * —á—Ç–µ–Ω–∏–µ –∏–∑ `audio_stream`
   * –¥–µ—Ç–µ–∫—Ç ‚Üí event –≤ FSM

5. **–°–≤—è–∑–∞—Ç—å –≤—Å—ë –≤ `main.c`**

   * init order:

     ```
     audio_bus
     audio_stream
     voice_fsm
     wakenet
     ```

6. **–¢–µ—Å—Ç—ã**

   * SOFT OFF + wake + –≥–æ–ª–æ—Å
   * anti-feedback
   * ON/OFF –Ω–µ —Ä–µ–≥—Ä–µ—Å—Å–∏—Ä—É–µ—Ç

---

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏ M4

### Must-have

* Wake —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ SOFT OFF
* –õ–∞–º–ø–∞ –æ—Ç–≤–µ—á–∞–µ—Ç –≥–æ–ª–æ—Å–æ–º
* –°–≤–µ—Ç –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç—Å—è
* Wake –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ –≤—Ä–µ–º—è SPEAK
* –ü–æ—Å–ª–µ SPEAK wake —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–µ–Ω

### Regression

* 20√ó POWER ON/OFF ‚Äî –∫–∞–∫ —Å–µ–π—á–∞—Å
* Audio RX –Ω–µ –¥–µ–≥—Ä–∞–¥–∏—Ä—É–µ—Ç –ø–æ—Å–ª–µ —Å–µ—Ä–∏–∏ SPEAK
