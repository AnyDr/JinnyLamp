Всё про беспровод: каналы, peer MAC, pairing, формат сообщений, ACK/ретраи, таймауты, версии протокола.

# ESP-NOW в Jinny Lamp

## 1. Назначение
ESP-NOW используется как локальный, быстрый и независимый от роутера канал управления лампой с пульта:
- POWER (вкл/выкл)
- PAUSE
- BRIGHTNESS (0..255)
- SPEED_PCT (10..300)
- SET_ANIM (effect_id)

Источник истины состояния - лампа. Пульт отправляет команду, лампа отвечает ACK со снимком состояния.

## 2. MAC адреса и pairing (факт текущей связки)
Спаривание делается по MAC (жёстко через menuconfig):
- В лампе: CONFIG_J_ESPNOW_PEER_MAC = MAC пульта
- В пульте: CONFIG_J_ESPNOW_PEER_MAC = MAC лампы

Фактические MAC (WiFi STA):
- Пульт: 98:88:E0:03:D5:F4
- Лампа: 10:B4:1D:EA:DF:C8

Node ID (факт по sdkconfig):
- Пульт: CONFIG_J_NODE_ID = 2
- Лампа: CONFIG_J_NODE_ID = 111

Если peer MAC не задан:
- peer не добавляется
- прием может работать, но надежность и предсказуемость хуже (зависит от того, кто и как добавляет peers)

## 3. Канал (критично)
ESPNOW работает на текущем канале Wi-Fi.

Стратегия канала:
- Если CONFIG_J_WIFI_SSID пустой:
  - Wi-Fi STA стартует без подключения к AP
  - выставляется fallback channel = CONFIG_J_WIFI_FALLBACK_CH (сейчас 1)
- Если SSID задан:
  - STA подключается к AP
  - канал определяется AP (через esp_wifi_get_channel)
  - ESPNOW должен работать на этом канале

Правило на будущее (MQTT/HA):
- “канал диктует AP”, ESPNOW следует ему
- если STA не подключен, используем fallback channel

## 4. Протокол сообщений (j_espnow_proto.h)
### 4.1 CTRL (команда)
Поля (в общем виде):
- magic/version/type
- src_node, dst_node (поддержан broadcast dst=0xFFFF)
- seq
- cmd + value_u16

Команды (логическая семантика, точные enum см. j_espnow_proto.h):
- POWER: value_u16 = 0/1
- SET_ANIM: value_u16 = effect_id
- SET_PAUSE: value_u16 = 0/1
- SET_BRIGHT: value_u16 = 0..255
- SET_SPEED_PCT: value_u16 = 10..300

### 4.2 ACK (ответ лампы)
ACK подтверждает ack_seq и возвращает snapshot состояния:
- effect_id
- brightness
- paused
- speed_pct
- state_seq (монотонно растет при применении состояния)

## 5. Обработка входящих команд (лампа)
Типовой путь:
1) RX: валидируется пакет (magic/ver/len)
2) маппинг cmd -> ctrl_cmd_t (маска полей)
3) ctrl_bus_submit()
4) формируется ACK (текущее состояние) и отправляется обратно

## 6. Диагностика
Смотри теги логов:
- J_WIFI (канал/STA режим, MAC)
- J_ESPNOW / ESPNOW (init/peer/recv/send)
Если “ничего не происходит”:
- первым делом проверять канал STA и соответствие peer MAC на обеих сторонах
- проверять, что обе стороны в STA режиме и ESPNOW init прошел без ошибок

## 7. Известные ограничения / TODO
- SET_ANIM заработает корректно только если таблица effect_id на пульте совпадает с fx_registry лампы
  (или будет сделан протокол запроса списка эффектов)
- В UI пульта сейчас возможно, что команды продолжают отправляться лампе даже при переключении экранов/устройств (это логика пульта, фиксируем как системный эффект)

## 8. Известная “грабля” по API (ESP-IDF v5.5.1)
В ESP-IDF v5.x send callback в ESPNOW ожидает тип с wifi_tx_info_t.
Если возникает ошибка несовместимого типа при esp_now_register_send_cb(),
значит callback объявлен по старой сигнатуре (const uint8_t *mac_addr,...).
Нужно использовать корректную сигнатуру из esp_now.h для текущей версии IDF.
