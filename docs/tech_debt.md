# Jinny Lamp — Tech debt и тонкие места (структурировано)

Этот файл фиксирует проблемные зоны, риски и задачи по доводке.
Правило: **ничего не удаляем и не “перестраиваем всё” без полного понимания контекста**.
Задачи сгруппированы по темам, есть приоритет (P0/P1/P2), место фиксации (docs/adr или TODO) и критерий готовности.

---

## 0) Быстрые задачи на ближайшую сессию (P0–P1)

### P0 — Deep sleep: отключать только матрицу, не “глушить мозг”
**Суть:** переписать deep sleep так, чтобы **выключалась только матрица**, а контроллер продолжал “слушать” wake word через XVF3800.  
**Риск сейчас:** deep sleep может делать устройство “глухим” для голосового сценария.  
**Где фиксировать:** `docs/adr/0002-deepsleep-voice-alive.md` (новый ADR) + кратко в `docs/architecture.md` (“Power management”).  
**Критерий готовности:** при “сне” матрица OFF, но XVF3800 продолжает детект, и пробуждение/событие приводит к включению матрицы без полной перезагрузки (или с минимально контролируемым рестартом, если так задумано).

---

### P1 — Пауза: “заморозить”, а не “перезапускать”
**Суть:** сейчас пауза останавливает и при повторном нажатии перезапускает; нужно, чтобы **продолжалось с той же фазы**.  
**Риск:** визуально ощущается как “глюк/сброс эффекта”, ломает UX.  
**Где фиксировать:** `docs/commands.md` (семантика PAUSE) + `docs/architecture.md` (как реализовано внутри fx_engine/matrix_anim).  
**Критерий готовности:** `paused=1` удерживает картинку/время эффекта, `paused=0` продолжает с той же фазы (без ресета seed/таймеров).

---

### P1 — Автокалибровка шума при старте (ASR)
**Суть:** проверить/описать, как реализована автокалибровка noise floor после включения.  
**Риск:** если калибровка нестабильна, все “уровни” и пороги пляшут.  
**Где фиксировать:** `docs/architecture.md` (Audio/ASR) + возможно ADR если будут решения по порогам.  
**Критерий готовности:** описан алгоритм (сколько кадров/время, условия), есть понятный лог/метрика “noise_floor=…”, повторяемость приемлемая.

---

## 1) Известные проблемы сборки и портирования эффектов (Known issues)

### K1 — fx_registry: дубли/конфликты символов render
**Факт/риск:** потенциальные дубли прототипов/символов, которые могут приводить к ошибкам линковки при включении/портировании пакетов эффектов:
- `fx_fireflies_render`
- `fx_checker_pulse_render`
- `fx_cubes_render` (исторически уже всплывал конфликт)
  
**Где фиксировать:**  
- `docs/architecture.md` в разделе FX (как “Known issue”)  
- `docs/adr/0003-fx-registry-symbol-uniqueness.md` (если будем менять правила именования/регистрации)  

**Критерий готовности:** один источник объявлений (один прототип на символ), уникальные имена render-функций, сборка чистая при включении всех эффектов.

---

## 2) Потоки/остановка задач и безопасное выключение матриц (Concurrency/Power)

### R1 — `matrix_anim_stop()` не “join”-ит задачу
**Факт:** stop ставит `s_run=false`, а в `main.c` перед deep sleep используется `vTaskDelay(150ms)` как эвристика.  
**Риск:** гонка: задача может не успеть выйти до выключения питания матриц -> артефакты/спайки/странные состояния WS2812.  
**Где фиксировать:** `docs/architecture.md` (инвариант владения матрицей) + TODO рядом с реализацией stop.  
**Критерий готовности:** stop гарантирует завершение task (через notify/join/handle + ожидание) до power-off, без магических задержек.

---

## 3) Wi-Fi/ESPNOW и совместимость с будущим MQTT

### R2 — Wi-Fi auth принудительно WPA2_PSK
**Факт:** `j_wifi.c` выставляет `WIFI_AUTH_WPA2_PSK`.  
**Риск:** WPA3-only сети могут не подключиться (когда появится MQTT).  
**Где фиксировать:** `docs/espnow.md` (будущее STA/MQTT) + ADR если примем решение “WPA2/WPA3 policy”.  
**Критерий готовности:** политика аутентификации описана, поведение предсказуемое (или авто, или конфигом).

---

### R3 — Канал Wi-Fi как ключевой риск при ESPNOW+STA
**Факт/риск:** при подключении к AP канал диктуется AP; ESPNOW обязан следовать каналу STA.  
**Где фиксировать:** `docs/espnow.md` + ADR “Channel strategy”.  
**Критерий готовности:** задокументирована стратегия и диагностические шаги (как проверить канал и почему “пропало”).

---

## 4) Wake/wakeup защита (Input/Wakeup)

### R4 — Wake guard зависит от уровня GPIO
**Факт:** wake guard проверяет удержание HIGH после EXT0; защита от ложных wake/long уже добавлялась.  
**Риск:** паразитные HIGH/наводки, “ложные пробуждения”.  
**Где фиксировать:** `docs/architecture.md` (Power/Input) + коротко в `docs/Handoff.md` как инвариант.  
**Критерий готовности:** документировано поведение и параметры (время удержания, rate-limit), подтверждено тестом.

---

## 5) Память/разделы/размер приложения

### R5 — Partition table: `factory` всего 1MB (текущее состояние)
**Факт:** по таблице разделов `factory` = 0x00100000 (1MB).  
**Риск:** проект может “не влезть” при росте эффектов/логики/логов.  
**Где фиксировать:** `docs/architecture.md` + `docs/commands.md` (как проверить size) + ADR при смене partitions.  
**Критерий готовности:** либо подтвержден запас, либо принята новая таблица разделов и добавлена в репо (не только bin в build).

---

## 6) Логи/шум и режимы отладки

### R6 — `asr_debug` лог-спам + loopback RX->TX
**Факт:** `asr_debug.c` может шуметь логом (например `LOG_EVERY_N_FRAMES=10` при `DEBUG_AUDIO_LEVEL=1`) и делает loopback.  
**Риск:** монитор превращается в водопад, сложно дебажить ESPNOW/MQTT/старт системы.  
**Где фиксировать:** `docs/architecture.md` (Audio debug как опциональный режим) + `docs/commands.md` (как выключать/понижать уровень).  
**Критерий готовности:** есть явный флаг/уровень логирования/способ временно отключать без выноса кучи кода.

---

## 7) Семантика/единицы измерения и именовательные оговорки

### N1 — `sense_acs758.c`: `dv_mV` сейчас не в mV
**Факт:** “delta raw” уходит в поле `dv_mV` (то есть это не mV).  
**Риск:** дальнейшие расчёты/интеграция дадут неверные единицы.  
**Где фиксировать:** `docs/architecture.md` (Sensors) + комментарий в коде рядом с полем/структурой.  
**Критерий готовности:** единицы измерения согласованы и названы честно (или поле переименовано, или добавлено отдельное поле).

---

### N2 — `led_control.c` управляет бортовым LED (не MOSFET матриц)
**Факт:** бортовой LED active-low на GPIO21, отдельно от MOSFET матриц.  
**Риск:** путаница в документации/логике “LED = питание матриц”.  
**Где фиксировать:** `docs/architecture.md` (GPIO/LEDs).  
**Критерий готовности:** в доках четко разделено: “status LED” и “matrix power MOSFET”.

---

## 8) Повторы и уже известные системные ограничения (не плодить дубликаты)
Следующие пункты не дублируем по всему репо, а поддерживаем единым источником:
- Рассинхрон effect_id между пультом и лампой (ломает SET_ANIM)
- Команды с пульта могут уходить даже при смене экранов (логика пульта)
- asr_debug спамит логами (временный режим)
- Wi-Fi канал критичен для ESPNOW при STA/MQTT
- предупреждения flash size / partition sizing

---

## 9) Рекомендованное размещение
Этот файл хранить как:
- `docs/analysis/tech_debt.md`

В `docs/Handoff.md` добавить ссылку на него (раздел “Known issues / Tech debt”).
